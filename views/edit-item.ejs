<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h2>Edit Item</h2>
<form action="/edit-item/<%= item.id_items %>?reference=<%= reference %>" method="POST">
  <label>Stock Code:</label>
  <input type="text" name="stock_code" value="<%= item.stock_code %>" required><br>

  <label>Description:</label>
  <input type="text" name="description" value="<%= item.description %>" required><br>

  <label>Quantity:</label>
  <input type="number" name="qty" value="<%= item.qty %>" required><br>

  <label>Unit Cost:</label>
  <input type="number" step="0.01" name="unit_cost" value="<%= item.unit_cost %>" required><br>
 
  <label>Labour Margin %:</label>
  <input type="number" step="0.01" name="labour_margin" value="<%= item.labour_margin %>" required><br>

  <label>Equipment Margin %:</label>
  <input type="number" step="0.01" name="equipment_margin" value="<%= item.equipment_margin %>" required><br>

         <input type="hidden" id="labour_factor_hrs" name="labour_factor_hrs" value="<%= item.labour_factor_hrs %>">
<input type="hidden" id="maint_lab_factor" name="maint_lab_factor" value="<%= item.maint_lab_factor %>">
        <div class="form-group">
            <label for="product_type">Select Product Type:</label>
            <select id="product_type" name="product_type" required>
                <option value="" disabled>Select a Product</option>
<% productTypes.forEach(type => { %>
  <option value="<%= type.product_type %>" <%= item.product_type === type.product_type ? 'selected' : '' %>><%= type.product_type %></option>
<% }); %>
            </select>
        </div>
          <div class="form-group">
      <label for="install_diff">Installation Difficulty:</label>
      <select id="install_diff" name="install_diff" required>
        <option value="" disabled>Select an install difficulty</option>
<% installDifficultyTypes.forEach(diff => { %>
  <option value="<%= diff.install_diff %>" <%= item.install_diff === diff.install_diff ? 'selected' : '' %>><%= diff.install_diff %></option>
<% }); %>
      </select>
    </div>
<input type="hidden" id="install_diff_factor" name="install_diff_factor" value="<%= item.install_diff_factor %>">
     <div class="form-group">
            <label for="supply">Supplier:</label>
            <select id="supply" name="supply" required>
               <option value="" disabled>Select a supplier</option>
<% supplyTypes.forEach(type => { %>
  <option value="<%= type.supply %>" <%= item.supply === type.supply ? 'selected' : '' %>><%= type.supply %></option>
<% }); %>
            </select>
        </div> 

  <button type="submit">Update</button>
</form>
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 <script>
    $(document).ready(function () {
      const installDifficultyTypes = <%- JSON.stringify(installDifficultyTypes) %>;
  
      $("#product_type").change(function () {
        var selectedProduct = $(this).val();
        var selectedProductData = <%- JSON.stringify(productTypes) %>.find(function (product) {
          return product.product_type === selectedProduct;
        });
  
        if (selectedProductData) {
          $("#labour_factor_hrs").val(selectedProductData.labour_factor_hrs);
          $("#maint_lab_factor").val(selectedProductData.maint_lab_factor);
        }
      });
  
      $('#install_diff').change(function () {
        const selectedDiff = $(this).val();
  
        const selectedDiffData = installDifficultyTypes.find(function (item) {
          return item.install_diff === selectedDiff;
        });
  
        if (selectedDiffData) {
          $('#install_diff_factor').val(selectedDiffData.install_diff_factor);
        }
      });

     $('#edit-item').on('submit', function (e) {
  e.preventDefault();

  const formData = $(this).serialize();
  const actionUrl = $(this).attr('action'); 

  $.ajax({
    url: actionUrl,
    type: 'POST',
    data: formData,
    success: function (response) {
      alert('Item updated successfully');
      window.location.href = '/allitems';
    },
    error: function (error) {
      alert('Error: ' + error.statusText);
    }
  });
});
});
  </script>
</body>
</html>